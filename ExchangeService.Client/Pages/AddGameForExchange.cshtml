@using ExchangeService.Shared.Resources;
@using ExchangeService.Client.Services;
@page "/addexchangegame"
@inject HttpClient Http
@inject TokenService tokenService
@inject AppState appState
@inject Microsoft.AspNetCore.Blazor.Services.IUriHelper UriHelper

<h1>Add game for exchange</h1>

<div class="form-group row">
    <label for="gameTitle" class="col-sm-6 col-form-label">Game title:</label>
    <div class="col-sm-6">
        <input type="text" class="form-control" id="gameTitle" placeholder="Title" bind="@GameTitle" />
    </div>
</div>


@if (gameWasSearched)
{
    @if (response != null && response.Length > 0)
    {
        <div class="form-group row">
            <label for="gameId" class="col-sm-6 col-form-label">Select game from existing or add a new one:</label>
            <div class="col-sm-3">
                <select bind="@SelectedId" class="form-control">
                    <option selected>Choose...</option>
                    @foreach (var game in response)
                    {
                        <option value="@game.Id">@game.Name</option>
                    }
                </select>
            </div>
            <div class="col-sm-3">
                <button type="button" class="btn btn-light" onclick=@(() => AddNewGame())>Add new game</button>
            </div>
        </div>
    }
    else
    {
        <div class="form-group row">
            <label for="gameId" class="col-sm-6 col-form-label">Game with provided title wasn't found. </label>
            <div class="col-sm-3">
                <button type="button" class="btn btn-light" onclick=@(() => AddNewGame())>Add new game</button>
            </div>
        </div>
    }


    @if (gameDetails != null)
    {
        <div class="form-group row">
            <label for="gameTitle" class="col-sm-6 col-form-label">Game title: </label>
            <div class="col-sm-6">
                <input type="text" class="form-control" id="gameTitle" placeholder="Title" bind="@gameDetails.Title" />
            </div>
        </div>
        <div class="form-group row">
            <label for="description" class="col-sm-6 col-form-label">Description: </label>
            <div class="col-sm-6">
                <input type="text" class="form-control" id="description" placeholder="Description" bind="@gameDetails.Description" />
            </div>
        </div>
        <div class="form-group row">
            <label for="publisher" class="col-sm-6 col-form-label">Publisher: </label>
            <div class="col-sm-6">
                <input type="text" class="form-control" id="publisher" placeholder="Publisher" bind="@gameDetails.Publisher" />
            </div>
        </div>
        <div class="form-group row">
            <label for="genre" class="col-sm-6 col-form-label">Genre: </label>
            <div class="col-sm-6">
                <input type="text" class="form-control" id="genre" placeholder="Genre" bind="@gameDetails.GenreName" />
            </div>
        </div>
        <div class="form-group row">
            <label for="playerCount" class="col-sm-6 col-form-label">Player count: </label>
            <div class="col-sm-6">
                <input type="text" class="form-control" id="playerCount" placeholder="Min-max" bind="@gameDetails.PlayerCount" />
            </div>
        </div>
        <div class="form-group row">
            <label for="ageRequired" class="col-sm-6 col-form-label"> Age required: </label>
            <div class="col-sm-6">
                <input type="number" class="form-control" id="ageRequired" placeholder="Age required" bind="@gameDetails.MinAgeRequired" />
            </div>
        </div>

        <button type="button" class="btn btn-primary" onclick=@(async () => await SaveGameDetails())>Save details</button>

        @if (newUserGame != null)
        {
            <div class="form-group row">
                <label for="shipment" class="col-sm-6 col-form-label"> Shipment type: </label>
                <div class="col-sm-6">
                    <input type="text" class="form-control" id="shipment" placeholder="Shipment" bind="@newUserGame.Shipment" />
                </div>
            </div>
            <div class="form-group row">
                <label for="isComplete" class="col-sm-6 col-form-label"> Is your game complete: </label>
                <div class="col-sm-6">
                    <input type="checkbox" class="form-control" id="isComplete" placeholder="false" bind="@newUserGame.IsComplete" />
                </div>
            </div>
            <div class="form-group row">
                <label for="gameState" class="col-sm-6 col-form-label"> Game state: </label>
                <div class="col-sm-6">
                    <input type="text" class="form-control" id="gameState" placeholder="Game state" bind="@newUserGame.State" />
                </div>
            </div>
            <div class="form-group row">
                <label for="stateDescription" class="col-sm-6 col-form-label"> State description: </label>
                <div class="col-sm-6">
                    <input type="text" class="form-control" id="stateDescription" placeholder="Description of game state" bind="@newUserGame.UserGameDescription" />
                </div>
            </div>

            <button type="button" class="btn btn-primary" onclick=@(async () => await AddUserGameToDB())>Add game for exchange</button>
        }
    }

}

@functions {
    DropDownItem[] response;
    bool gameWasSearched = false;
    bool gameDoesntExist = true;
    GameDto gameDetails = null;
    UserGameDto newUserGame = null;
    string gameID;

    string gameTitle = null;
    public string GameTitle
    {
        get => gameTitle;
        set
        {
            gameTitle = value;
            if (!string.IsNullOrEmpty(gameTitle)) FillAutoComplete().ConfigureAwait(false);
            StateHasChanged();
        }
    }

    string selectedId = null;
    public string SelectedId
    {
        get => selectedId;
        set
        {
            selectedId = value;
            if (!string.IsNullOrEmpty(selectedId)) GetGameDetails().ConfigureAwait(false);
        }
    }

    protected override void OnInit()
    {
        appState.TrySetAccessTokens();
    }

    private async Task FillAutoComplete()
    {
        response = await Http.GetJsonAsync<DropDownItem[]>("http://localhost:5000/api/games/" + GameTitle);
        SelectedId = null;
        gameWasSearched = true;
        gameDetails = null;
        newUserGame = null;
        StateHasChanged();
    }

    private void AddNewGame()
    {
        gameDetails = new GameDto();
        SelectedId = string.Empty;
        GameTitle = string.Empty;
        gameDoesntExist = true;
        newUserGame = null;
    }

    private async Task GetGameDetails()
    {
        gameDetails = await Http.GetJsonAsync<GameDto>("http://localhost:5000/api/games/get/" + SelectedId);
        gameDoesntExist = false;
        GameTitle = string.Empty;
        newUserGame = null;
        gameID = gameDetails.GameId.ToString();
        StateHasChanged();
    }

    private async Task SaveGameDetails()
    {
        if (gameDoesntExist)
            await AddGameToDB();
        else
            await UpdateGameInDB();

        newUserGame = new UserGameDto()
        {
            GameId = Int32.Parse(gameID)
        };
    }

    private async Task AddGameToDB()
    {
        await Http.PostJsonAsync("http://localhost:5000/api/games/", gameDetails);
        var games = await Http.GetJsonAsync<DropDownItem[]>("http://localhost:5000/api/games/" + gameDetails.Title);
        gameID = games[0].Id.ToString();
    }

    private async Task UpdateGameInDB()
    {
        await Http.PutJsonAsync("http://localhost:5000/api/games/", gameDetails);
    }

    private async Task AddUserGameToDB()
    {
        await Http.PostJsonAsync("http://localhost:5000/api/users/games/", newUserGame);
        UriHelper.NavigateTo("/gameexchangesuccess");
    }
}
